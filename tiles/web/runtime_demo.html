<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TownScout Runtime Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 300px;
        }
        .row { margin: 10px 0; }
        label { display: inline-block; width: 150px; }
        input[type="range"] { width: 150px; }
        .value { margin-left: 10px; font-weight: bold; }
        button { 
            padding: 8px 16px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .status { margin-top: 10px; padding: 8px; border-radius: 4px; }
        .loading { background: #e3f2fd; color: #1976d2; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>

<div class="panel">
    <h3>TownScout Runtime Demo</h3>
    <div class="row">
        <label>Chipotle ≤ minutes:</label>
        <input type="range" id="chipotle" min="5" max="45" step="5" value="15">
        <span class="value" id="chipotle_value">15</span>
    </div>
    <div class="row">
        <label>Costco ≤ minutes:</label>
        <input type="range" id="costco" min="5" max="60" step="5" value="20">
        <span class="value" id="costco_value">20</span>
    </div>
    <div class="row">
        <label>Airports ≤ minutes:</label>
        <input type="range" id="airports" min="10" max="240" step="10" value="120">
        <span class="value" id="airports_value">120</span>
    </div>
    <div class="row">
        <button onclick="updateMap()">Update Map</button>
    </div>
    <div id="status" class="status">Ready</div>
</div>

<div id="map"></div>

<script>
// Initialize map centered on Massachusetts
const map = new maplibregl.Map({
    container: 'map',
    style: {
        version: 8,
        sources: {
            'osm': {
                type: 'raster',
                tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                tileSize: 256,
                attribution: '© OpenStreetMap contributors'
            }
        },
        layers: [{
            id: 'osm-base',
            type: 'raster',
            source: 'osm'
        }]
    },
    center: [-71.06, 42.36], // Boston area
    zoom: 8
});

// Update slider value displays
['chipotle', 'costco', 'airports'].forEach(id => {
    const slider = document.getElementById(id);
    const display = document.getElementById(id + '_value');
    slider.addEventListener('input', function() {
        display.textContent = this.value;
    });
});

let currentLayer = null;

async function updateMap() {
    const center = map.getCenter();
    const zoom = Math.max(8, Math.min(12, Math.floor(map.getZoom())));
    
    // Simple single-tile approach for demo
    const scale = Math.pow(2, zoom);
    const x = Math.floor((center.lng + 180) / 360 * scale);
    const y = Math.floor((1 - Math.log(Math.tan(center.lat * Math.PI / 180) + 1 / Math.cos(center.lat * Math.PI / 180)) / Math.PI) / 2 * scale);
    
    const criteria = [
        {
            category: "chipotle",
            mode: "drive",
            threshold: parseInt(document.getElementById('chipotle').value),
            op: "AND"
        },
        {
            category: "costco", 
            mode: "drive",
            threshold: parseInt(document.getElementById('costco').value),
            op: "AND"
        },
        {
            category: "airports",
            mode: "drive", 
            threshold: parseInt(document.getElementById('airports').value),
            op: "AND"
        }
    ];
    
    const status = document.getElementById('status');
    status.textContent = 'Loading...';
    status.className = 'status loading';
    
    try {
        const params = new URLSearchParams({
            z: zoom,
            x: x,
            y: y,
            res: 8,
            unit: 'minutes',
            criteria: JSON.stringify(criteria)
        });
        
        const response = await fetch(`/api/criteria?${params}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const geojson = await response.json();
        
        // Remove existing layer
        if (currentLayer && map.getLayer(currentLayer)) {
            map.removeLayer(currentLayer);
            map.removeSource(currentLayer);
        }
        
        // Add new layer
        currentLayer = 'criteria-results';
        map.addSource(currentLayer, {
            type: 'geojson',
            data: geojson
        });
        
        map.addLayer({
            id: currentLayer,
            type: 'fill',
            source: currentLayer,
            paint: {
                'fill-color': '#4CAF50',
                'fill-opacity': 0.6,
                'fill-outline-color': '#2E7D32'
            }
        });
        
        status.textContent = `Found ${geojson.features.length} matching areas`;
        status.className = geojson.features.length > 0 ? 'status success' : 'status error';
        
    } catch (error) {
        console.error('Error:', error);
        status.textContent = 'Error: ' + error.message;
        status.className = 'status error';
    }
}

// Initial map load
map.on('load', function() {
    updateMap();
});
</script>

</body>
</html> 