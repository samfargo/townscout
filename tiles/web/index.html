<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TownScout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <!-- Use pmtiles.js for protocol -->
  <script src="/tiles/web/pmtiles.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .panel { position: absolute; top: 16px; left: 16px; background: #fff; padding: 14px 16px; border-radius: 10px; z-index: 1; box-shadow: 0 6px 20px rgba(0,0,0,0.12); width: 320px; }
    .panel h3 { margin: 0 0 12px; font-size: 16px; font-weight: 600; color: #1f2937; }
    .row { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
    .row label { flex: 1; font-size: 13px; color: #374151; }
    .row input[type="range"] { flex: 1.6; }
    .row span { font-weight: 600; width: 36px; text-align: right; color: #111827; }
    .row select { flex: 1; padding: 6px 8px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb; color: #111827; font-size: 13px; }
    .row select:focus { outline: none; border-color: #93c5fd; box-shadow: 0 0 0 3px rgba(59,130,246,0.25); }
    .filter-row { align-items: center; }
    .filter-row .spacer { flex: 0.2; }
    .remove-btn { background: transparent; border: none; color: #6b7280; cursor: pointer; padding: 4px 6px; border-radius: 6px; font-size: 13px; }
    .remove-btn:hover { background: #f3f4f6; color: #111827; }
    .status { margin-top: 10px; font-size: 12px; }
    .nudge { font-size: 12px; color: #666; background: #eee; padding: 5px; border-radius: 3px; display: none; }
    .footer { position: absolute; bottom: 5px; right: 10px; font-size: 11px; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 3px; z-index: 1; }
    .hover-box { position: absolute; top: 10px; right: 10px; background: #fff; padding: 10px 12px; border-radius: 6px; z-index: 2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-width: 220px; max-width: 280px; pointer-events: none; }
    .hover-box h4 { margin: 0 0 8px; font-size: 14px; font-weight: 600; }
    .hover-box .kv { display: flex; justify-content: space-between; font-size: 13px; margin: 4px 0; }
    .hover-box .muted { color: #666; font-size: 12px; }
    .towns-box { position: absolute; top: 120px; right: 10px; background: #fff; padding: 10px 12px; border-radius: 6px; z-index: 2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-width: 240px; max-width: 300px; pointer-events: auto; }
    .towns-box h4 { margin: 0 0 8px; font-size: 14px; font-weight: 600; }
    .towns-box ul { margin: 0; padding-left: 18px; max-height: 220px; overflow: auto; }
    .towns-box .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
<div class="panel">
  <h3>TownScout Criteria</h3>
  <div id="filters">
    <div class="row">
      <label for="chipotle_drive_min">Chipotle (minutes)</label>
      <input id="chipotle_drive_min" type="range" min="5" max="45" step="5" value="15">
      <span id="chipotle_drive_min_v">15</span>
    </div>
    <div class="row">
      <label for="costco_drive_min">Costco (minutes)</label>
      <input id="costco_drive_min" type="range" min="5" max="60" step="5" value="20">
      <span id="costco_drive_min_v">20</span>
    </div>
  </div>
  <div id="nudge" class="nudge">Try increasing minutes to see more areas.</div>
  <button id="share" style="width: 100%; margin-top: 10px; padding: 5px;">Share Map</button>
</div>

<div id="map"></div>

<div id="hover-box" class="hover-box">
  <h4>Drive Time (minutes)</h4>
  <div id="hover-content" class="muted">Move cursor over a hex</div>
</div>

<div class="footer">
  Map data © OpenStreetMap contributors
</div>

<script>
  // ---------- PMTiles Protocol ----------
  let protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const R7_URL = "pmtiles:///tiles/us_r7.pmtiles";
  const R8_URL = "pmtiles:///tiles/us_r8.pmtiles";

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'osm': {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '© OpenStreetMap contributors'
        },
        'us_r7': {
          type: 'vector',
          url: R7_URL,
          attribution: "TownScout"
        },
        'us_r8': {
          type: 'vector',
          url: R8_URL
        }
      },
      layers: [
        { id: 'osm-base', type: 'raster', source: 'osm', paint: { 'raster-opacity': 0.7 } },
        {
          id: 'layer_r7',
          type: 'fill',
          source: 'us_r7',
          'source-layer': 'us_r7',
          maxzoom: 8,
          paint: {
            'fill-color': '#1976d2',
            'fill-opacity': 0.5,
            'fill-outline-color': 'rgba(0, 0, 0, 0.1)'
          }
        },
        {
          id: 'layer_r8',
          type: 'fill',
          source: 'us_r8',
          'source-layer': 'us_r8',
          minzoom: 8,
          paint: {
            'fill-color': '#1976d2',
            'fill-opacity': 0.5,
            'fill-outline-color': 'rgba(0, 0, 0, 0.1)'
          }
        }
      ]
    },
    center: [-98.58, 39.83], // US center
    zoom: 4
  });

  // ---------- Hover Box ----------
  function updateHoverBox(feature) {
    const contentEl = document.getElementById('hover-content');
    if (!feature || !feature.properties) {
      contentEl.innerHTML = '<span class="muted">Move cursor over a hex</span>';
      return;
    }
    const props = feature.properties;
    const chipotle_min = props.chipotle_drive_min;
    const costco_min = props.costco_drive_min;
    
    let html = '';
    html += `<div class="kv"><span>Chipotle</span><span>${chipotle_min ? chipotle_min + ' min' : 'N/A'}</span></div>`;
    html += `<div class="kv"><span>Costco</span><span>${costco_min ? costco_min + ' min' : 'N/A'}</span></div>`;
    contentEl.innerHTML = html;
  }
  
  // ---------- Filter Logic ----------
  const chipotleSlider = document.getElementById('chipotle_drive_min');
  const costcoSlider = document.getElementById('costco_drive_min');
  const chipotleValue = document.getElementById('chipotle_drive_min_v');
  const costcoValue = document.getElementById('costco_drive_min_v');

  function updateMapFilter() {
    const chipotleMax = parseInt(chipotleSlider.value, 10);
    const costcoMax = parseInt(costcoSlider.value, 10);
    
    chipotleValue.textContent = chipotleMax;
    costcoValue.textContent = costcoMax;

    const filter = [
      "all",
      ["<=", ["coalesce", ["get", "chipotle_drive_min"], 9999], chipotleMax],
      ["<=", ["coalesce", ["get", "costco_drive_min"], 9999], costcoMax]
    ];
    
    map.setFilter('layer_r7', filter);
    map.setFilter('layer_r8', filter);
  }

  function debounce(fn, ms) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), ms);
    };
  }
  
  const debouncedUpdate = debounce(updateMapFilter, 50);

  chipotleSlider.addEventListener('input', debouncedUpdate);
  costcoSlider.addEventListener('input', debouncedUpdate);

  // ---------- Share URL ----------
  document.getElementById('share').addEventListener('click', () => {
    const params = new URLSearchParams();
    params.set('chipotle', chipotleSlider.value);
    params.set('costco', costcoSlider.value);
    const url = new URL(window.location.href);
    url.search = params.toString();
    navigator.clipboard.writeText(url.toString()).then(() => {
      const btn = document.getElementById('share');
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => (btn.textContent = originalText), 1500);
    });
  });

  function applyUrlParams() {
    const params = new URLSearchParams(window.location.search);
    if (params.has('chipotle')) {
      chipotleSlider.value = params.get('chipotle');
    }
    if (params.has('costco')) {
      costcoSlider.value = params.get('costco');
    }
  }

  // ---------- Map Events ----------
  map.on('load', () => {
    applyUrlParams();
    updateMapFilter();

    map.on('mousemove', (e) => {
      const features = map.queryRenderedFeatures(e.point, { layers: ['layer_r7', 'layer_r8'] });
      if (features && features.length > 0) {
        updateHoverBox(features[0]);
      } else {
        updateHoverBox(null);
      }
    });
  });

</script>
</body>
</html>