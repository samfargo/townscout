<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TownScout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <link rel="stylesheet" href="/static/web/style.css" />
</head>
<body>
<div class="panel">
  <h3>TownScout Criteria</h3>
  <div class="row">
    <label>Chipotle ≤ min</label>
    <input id="chipotle" type="range" min="5" max="45" step="5" value="15">
    <span id="chipotle_v">15</span>
  </div>
  <div class="row">
    <label>Costco ≤ min</label>
    <input id="costco" type="range" min="5" max="60" step="5" value="20">
    <span id="costco_v">20</span>
  </div>
  <div class="row">
    <label>Major airport ≤ min</label>
    <input id="airports" type="range" min="10" max="240" step="10" value="120">
    <span id="airports_v">120</span>
  </div>
  <div class="row">
    <button id="update">Update Map</button>
    <button id="share">Share Map</button>
  </div>
  <div id="status" class="status"></div>
  <div id="nudge" class="nudge" style="display:none;"></div>
</div>

<div id="map"></div>

<div id="info-panel" class="info-panel">
  <div class="info-panel-title">Area Information</div>
  <div id="info-content" class="info-panel-content">
    <!-- Content will be populated by JavaScript -->
  </div>
  <div id="info-placeholder" class="info-panel-placeholder">
    Hover over an area to see details
  </div>
</div>

<div class="footer">
  Map data © OpenStreetMap contributors
</div>

<script src="https://unpkg.com/pmtiles@2.7.0/dist/pmtiles.js"></script>
<script>
  // Initialize pmtiles protocol
  let protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const R7_SOURCE_ID = "ts_r7";
  const R7_LAYER_ID = "ts_r7_fill";
  const R8_SOURCE_ID = "ts_r8";
  const R8_LAYER_ID = "ts_r8_fill";
  const R7_URL = "/tiles/us_r7.pmtiles";
  const R8_URL = "/tiles/us_r8.pmtiles";

  // Debounce function
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Sliders and filters
  const SLIDERS = [
    { id: "chipotle", prop: "chipotle_drive_min", max: 45, init: 15 },
    { id: "costco", prop: "costco_drive_min", max: 60, init: 20 },
    { id: "airports", prop: "airports_drive_min", max: 240, init: 120 },
  ];
  let hoveredHexId = null;

  function getFilterExpression() {
    const filters = ["all"];
    for (const s of SLIDERS) {
      const val = parseInt(document.getElementById(s.id).value, 10);
      // Use coalesce to treat missing values as a large number (effectively passing the check)
      filters.push(["<=", ["coalesce", ["get", s.prop], 9999], val]);
    }
    return filters;
  }

  function updateFilters() {
    const filterExpr = getFilterExpression();
    if (map.getLayer(R7_LAYER_ID)) {
      map.setFilter(R7_LAYER_ID, filterExpr);
    }
    if (map.getLayer(R8_LAYER_ID)) {
      map.setFilter(R8_LAYER_ID, filterExpr);
    }
    updateShareUrl();
    checkVisibleFeatures();
  }

  // Nudge if no features are visible
  const checkVisibleFeatures = debounce(() => {
    const featuresR7 = map.queryRenderedFeatures({ layers: [R7_LAYER_ID] });
    const featuresR8 = map.queryRenderedFeatures({ layers: [R8_LAYER_ID] });
    const nudge = document.getElementById('nudge');
    if (featuresR7.length === 0 && featuresR8.length === 0) {
      nudge.textContent = "No areas match your criteria. Try increasing drive times.";
      nudge.style.display = 'block';
    } else {
      nudge.style.display = 'none';
    }
  }, 500);

  // Share URL logic
  function updateShareUrl() {
    const params = new URLSearchParams();
    for (const s of SLIDERS) {
      params.set(s.id, document.getElementById(s.id).value);
    }
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.history.replaceState({}, '', newUrl);
  }

  function loadUrlParams() {
    const params = new URLSearchParams(window.location.search);
    for (const s of SLIDERS) {
      if (params.has(s.id)) {
        const val = parseInt(params.get(s.id), 10);
        document.getElementById(s.id).value = val;
        document.getElementById(s.id + '_v').textContent = val;
      }
    }
  }

  function setupInfoPanel() {
    const infoPanel = document.getElementById('info-panel');
    const infoContent = document.getElementById('info-content');
    const infoPlaceholder = document.getElementById('info-placeholder');

    const onMouseMove = (e) => {
      if (!e.features || e.features.length === 0) {
        infoContent.innerHTML = '';
        infoPlaceholder.style.display = 'block';
        if (hoveredHexId !== null) {
          map.setFeatureState({ source: R7_SOURCE_ID, sourceLayer: "us_r7", id: hoveredHexId }, { hover: false });
          map.setFeatureState({ source: R8_SOURCE_ID, sourceLayer: "us_r8", id: hoveredHexId }, { hover: false });
          hoveredHexId = null;
        }
        return;
      }

      infoPlaceholder.style.display = 'none';
      const feat = e.features[0];

      if (hoveredHexId !== feat.id) {
        if (hoveredHexId !== null) {
          map.setFeatureState({ source: R7_SOURCE_ID, sourceLayer: "us_r7", id: hoveredHexId }, { hover: false });
          map.setFeatureState({ source: R8_SOURCE_ID, sourceLayer: "us_r8", id: hoveredHexId }, { hover: false });
        }
        hoveredHexId = feat.id;
        map.setFeatureState({ source: feat.source, sourceLayer: feat.sourceLayer, id: hoveredHexId }, { hover: true });
      }

      let content = '<ul>';
      for (const s of SLIDERS) {
        const val = feat.properties[s.prop];
        const status = (val !== null && val <= parseInt(document.getElementById(s.id).value, 10)) ? '✅' : '❌';
        content += `<li>${s.id}: ${val !== null ? val : 'N/A'} min ${status}</li>`;
      }
      content += '</ul>';
      infoContent.innerHTML = content;
    };
    
    const onMouseLeave = () => {
        infoContent.innerHTML = '';
        infoPlaceholder.style.display = 'block';
        if (hoveredHexId !== null) {
          map.setFeatureState({ source: R7_SOURCE_ID, sourceLayer: "us_r7", id: hoveredHexId }, { hover: false });
          map.setFeatureState({ source: R8_SOURCE_ID, sourceLayer: "us_r8", id: hoveredHexId }, { hover: false });
          hoveredHexId = null;
        }
    };

    map.on('mousemove', R7_LAYER_ID, onMouseMove);
    map.on('mouseleave', R7_LAYER_ID, onMouseLeave);
    map.on('mousemove', R8_LAYER_ID, onMouseMove);
    map.on('mouseleave', R8_LAYER_ID, onMouseLeave);
  }

  // Initialize map and controls
  map.on('load', () => {
    // Add PMTiles sources
    map.addSource(R7_SOURCE_ID, {
      type: "vector",
      url: `pmtiles://${R7_URL}`,
      attribution: '© OpenStreetMap contributors'
    });
    map.addSource(R8_SOURCE_ID, {
      type: "vector",
      url: `pmtiles://${R8_URL}`,
    });

    // Add layers
    map.addLayer({
      "id": R7_LAYER_ID,
      "type": "fill",
      "source": R7_SOURCE_ID,
      "source-layer": "us_r7",
      "maxzoom": 8,
      "paint": {
        "fill-color": "#4CAF50",
        "fill-opacity": [
            "case",
            ["boolean", ["feature-state", "hover"], false],
            0.8,
            0.5
        ],
        "fill-outline-color": "rgba(0, 0, 0, 0.1)"
      }
    });

    map.addLayer({
      "id": R8_LAYER_ID,
      "type": "fill",
      "source": R8_SOURCE_ID,
      "source-layer": "us_r8",
      "minzoom": 8,
      "paint": {
        "fill-color": "#4CAF50",
        "fill-opacity": [
            "case",
            ["boolean", ["feature-state", "hover"], false],
            0.8,
            0.5
        ],
        "fill-outline-color": "rgba(0, 0, 0, 0.1)"
      }
    });

    // Setup sliders
    for (const s of SLIDERS) {
      const slider = document.getElementById(s.id);
      const display = document.getElementById(s.id + '_v');
      slider.addEventListener('input', () => {
        display.textContent = slider.value;
      });
      slider.addEventListener('change', debounce(updateFilters, 50));
    }

    // Share button
    document.getElementById('share').addEventListener('click', () => {
      navigator.clipboard.writeText(window.location.href).then(() => {
        const btn = document.getElementById('share');
        btn.textContent = 'Copied!';
        setTimeout(() => (btn.textContent = 'Share Map'), 1000);
      });
    });
    
    // Manual update button (now just for aesthetics, filtering is live)
    document.getElementById('update').addEventListener('click', updateFilters);

    // Initial state
    loadUrlParams();
    updateFilters();
    setupInfoPanel();
  });

  // Error handling
  map.on('error', (e) => {
    console.error('Map error:', e);
  });
</script>
</body>
</html> 