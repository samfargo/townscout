<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TownScout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <!-- Use pmtiles.js for protocol -->
  <script src="/static/pmtiles.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .panel { position: absolute; top: 10px; left: 10px; background: #fff; padding: 10px 15px; border-radius: 6px; z-index: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 280px; }
    .panel h3 { margin: 0 0 10px; }
    .row { display: flex; align-items: center; margin-bottom: 8px; }
    .row label { flex: 1; font-size: 14px; }
    .row input[type="range"] { flex: 2; }
    .row span { font-weight: bold; width: 30px; text-align: right; }
    .status { margin-top: 10px; font-size: 12px; }
    .nudge { font-size: 12px; color: #666; background: #eee; padding: 5px; border-radius: 3px; display: none; }
    .footer { position: absolute; bottom: 5px; right: 10px; font-size: 11px; background: rgba(255,255,255,0.7); padding: 2px 5px; border-radius: 3px; z-index: 1; }
  </style>
</head>
<body>
<div class="panel">
  <h3>TownScout Criteria</h3>
  <div class="row">
    <label>Chipotle ≤ min</label>
    <input id="chipotle" type="range" min="5" max="45" step="5" value="15">
    <span id="chipotle_v">15</span>
  </div>
  <div class="row">
    <label>Costco ≤ min</label>
    <input id="costco" type="range" min="5" max="60" step="5" value="20">
    <span id="costco_v">20</span>
  </div>
  <div class="row">
    <label>Airports ≤ min</label>
    <input id="airports" type="range" min="15" max="240" step="15" value="60">
    <span id="airports_v">60</span>
  </div>
  <!-- Add more sliders here if needed -->
  <div id="status" class="status"></div>
  <div id="nudge" class="nudge">Try increasing minutes to see more areas.</div>
  <button id="share" style="width: 100%; margin-top: 10px; padding: 5px;">Share Map</button>
</div>

<div id="map"></div>

<div class="footer">
  Map data © OpenStreetMap contributors
</div>

<script>
  // ---------- PMTiles Protocol ----------
  let protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  const T_HEX_R7_URL = "pmtiles:///tiles/t_hex_r7_drive.pmtiles";
  const T_HEX_R8_URL = "pmtiles:///tiles/t_hex_r8_drive.pmtiles";
  const D_ANCHOR_API = "http://localhost:5174/api/d_anchor"; // Port from api/app/main.py

  // Store anchor data: { costco: {123: 360, ...}, chipotle: { ... } }
  const dAnchorState = {};
  const K_ANCHORS = 4; // Should match precompute_t_hex.py --k-best

  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        'osm': {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '© OpenStreetMap contributors'
        },
        't_hex_r7': {
          type: 'vector',
          url: T_HEX_R7_URL,
          attribution: "TownScout"
        },
        't_hex_r8': {
          type: 'vector',
          url: T_HEX_R8_URL
        }
      },
      layers: [
        { id: 'osm-base', type: 'raster', source: 'osm', paint: { 'raster-opacity': 0.7 } },
        {
          id: 't_hex_r7_layer',
          type: 'fill',
          source: 't_hex_r7',
          'source-layer': 't_hex_r7_drive', // Must match --layer in 06_build_tiles.py
          maxzoom: 8,
          paint: {
            'fill-color': 'rgba(25, 118, 210, 0.5)',
            'fill-outline-color': 'rgba(0, 0, 0, 0.1)'
          }
        },
        {
          id: 't_hex_r8_layer',
          type: 'fill',
          source: 't_hex_r8',
          'source-layer': 't_hex_r8_drive', // Must match --layer in 06_build_tiles.py
          minzoom: 8,
          paint: {
            'fill-color': 'rgba(25, 118, 210, 0.5)',
            'fill-outline-color': 'rgba(0, 0, 0, 0.1)'
          }
        }
      ]
    },
    center: [-71.06, 42.36],
    zoom: 8
  });

  function debounce(fn, ms) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), ms);
    };
  }
  
  function getSliderValues() {
    return {
      chipotle: +document.getElementById('chipotle').value * 60, // convert min to sec
      costco:   +document.getElementById('costco').value * 60,
      airports: +document.getElementById('airports').value * 60,
    };
  }

  // ---------- Core Logic: Build Filter Expression ----------
  function buildFilterExpression(criteria, dAnchorData) {
    const UNREACHABLE = 65535; // Sentinel for unreachable in uint16
    const expressions = [];

    for (const [category, thresholdSecs] of Object.entries(criteria)) {
      const categoryData = dAnchorData[category];
      if (!categoryData) continue; // Skip if data not loaded

      // For each category, calculate minimum travel time across all anchors
      const travelTimeOptions = [];
      for (let i = 0; i < K_ANCHORS; i++) {
        // Calculate total travel time: hex→anchor + anchor→category
        travelTimeOptions.push([
          "+",
          ["coalesce", ["get", `a${i}_s`], UNREACHABLE], // hex → anchor travel time
          ["coalesce", 
            ["get", ["to-string", ["get", `a${i}_id`]], ["literal", categoryData]], 
            UNREACHABLE
          ] // anchor → category travel time
        ]);
      }
      
      // Take minimum travel time across all anchor options
      const minTravelTime = ["min", ...travelTimeOptions];
      
      // Check if minimum travel time is within threshold
      expressions.push(["<=", minTravelTime, thresholdSecs]);
    }
    
    // Final expression shows hex if ALL criteria are met
    return ["case", ["all", ...expressions], 0.8, 0.0]; // opacity
  }

  // ---------- Main Update Function ----------
  async function updateMap() {
    document.getElementById('status').textContent = 'Updating...';
    
    const criteria = getSliderValues();
    const categories = Object.keys(criteria);
    let needsUpdate = false;

    // Fetch any missing D_anchor data
    for (const cat of categories) {
      if (!dAnchorState[cat]) {
        try {
          const resp = await fetch(`${D_ANCHOR_API}?category=${cat}&mode=drive`);
          if (!resp.ok) throw new Error(`API fetch failed for ${cat}: ${resp.status}`);
          dAnchorState[cat] = await resp.json();
          needsUpdate = true;
        } catch (err) {
          console.error(err);
          document.getElementById('status').textContent = `Error: ${err.message}`;
          return;
        }
      }
    }
    
    // Only rebuild expression if data changed or it's the first run
    const expression = buildFilterExpression(criteria, dAnchorState);

    // Apply the same expression to both layers
    map.setPaintProperty('t_hex_r7_layer', 'fill-opacity', expression);
    map.setPaintProperty('t_hex_r8_layer', 'fill-opacity', expression);
    
    document.getElementById('status').textContent = 'Map updated.';
    // Note: Nudge logic for "zero results" is harder with this architecture
    // as we can't easily count visible hexes. A simpler "no data?" nudge is used.
  }
  
  // ---------- UI & Event Listeners ----------
  function initUI() {
    const sliders = ['chipotle', 'costco', 'airports'];
    const debouncedUpdate = debounce(updateMap, 250);

    sliders.forEach(id => {
      const slider = document.getElementById(id);
      const output = document.getElementById(id + '_v');
      slider.addEventListener('input', () => {
        output.textContent = slider.value;
        debouncedUpdate();
      });
    });

    // Handle share button
    document.getElementById('share').addEventListener('click', () => {
      const params = new URLSearchParams();
      sliders.forEach(id => params.set(id, document.getElementById(id).value));
      const url = new URL(window.location.href);
      url.search = params.toString();
      navigator.clipboard.writeText(url.toString()).then(() => {
        const btn = document.getElementById('share');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => (btn.textContent = originalText), 1500);
      });
    });
    
    // Load initial state from URL params
    const params = new URLSearchParams(window.location.search);
    sliders.forEach(id => {
      if (params.has(id)) {
        const val = params.get(id);
        document.getElementById(id).value = val;
        document.getElementById(id + '_v').textContent = val;
      }
    });
  }

  map.on('load', () => {
    initUI();
    updateMap(); // Initial map load
  });
</script>
</body>
</html>